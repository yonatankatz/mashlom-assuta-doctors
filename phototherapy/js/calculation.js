var percentile40DataPoints = [
    { x: 12, y: 4.0 },
    { x: 16, y: 4.4 },
    { x: 20, y: 4.7 },
    { x: 24, y: 4.9 },
    { x: 28, y: 5.5 },
    { x: 32, y: 6.3 },
    { x: 36, y: 7.0 },
    { x: 40, y: 7.7 },
    { x: 44, y: 8.2 },
    { x: 48, y: 8.6 },
    { x: 52, y: 9.0 },
    { x: 56, y: 9.3 },
    { x: 60, y: 9.6 },
    { x: 64, y: 10.2 },
    { x: 68, y: 10.7 },
    { x: 72, y: 11.2 },
    { x: 76, y: 11.3 },
    { x: 80, y: 11.4 },
    { x: 84, y: 11.6 },
    { x: 88, y: 11.8 },
    { x: 92, y: 12.2 },
    { x: 96, y: 12.3 },
    { x: 100, y: 12.5 },
    { x: 104, y: 12.7 },
    { x: 108, y: 12.8 },
    { x: 112, y: 13.0 },
    { x: 116, y: 13.1 },
    { x: 120, y: 13.2 },
    { x: 124, y: 13.2 },
    { x: 128, y: 13.2 },
    { x: 132, y: 13.2 },
    { x: 136, y: 13.2 },
    { x: 140, y: 13.2 },
    { x: 144, y: 13.2 },
    { x: 148, y: 13.2 }
];

var percentile75DataPoints = [
    { x: 12, y: 5.0 },
    { x: 16, y: 5.5 },
    { x: 20, y: 5.9 },
    { x: 24, y: 6.1 },
    { x: 28, y: 7.0 },
    { x: 32, y: 8.0 },
    { x: 36, y: 8.9 },
    { x: 40, y: 9.9 },
    { x: 44, y: 10.3 },
    { x: 48, y: 10.8 },
    { x: 52, y: 11.3 },
    { x: 56, y: 12.0 },
    { x: 60, y: 12.6 },
    { x: 64, y: 12.9 },
    { x: 68, y: 13.1 },
    { x: 72, y: 13.4 },
    { x: 76, y: 13.8 },
    { x: 80, y: 14.3 },
    { x: 84, y: 14.7 },
    { x: 88, y: 14.7 },
    { x: 92, y: 15.0 },
    { x: 96, y: 15.2 },
    { x: 100, y: 15.3 },
    { x: 104, y: 15.4 },
    { x: 108, y: 15.5 },
    { x: 112, y: 15.6 },
    { x: 116, y: 15.7 },
    { x: 120, y: 15.8 },
    { x: 124, y: 15.7 },
    { x: 128, y: 15.6 },
    { x: 132, y: 15.5 },
    { x: 136, y: 15.4 },
    { x: 140, y: 15.3 },
    { x: 144, y: 15.2 },
    { x: 148, y: 15.3}
];

var percentile95DataPoints = [
    { x: 12, y: 7.0 },
    { x: 16, y: 7.2 },
    { x: 20, y: 7.4 },
    { x: 24, y: 7.8 },
    { x: 28, y: 8.9 },
    { x: 32, y: 10.0 },
    { x: 36, y: 11.1 },
    { x: 40, y: 12.2 },
    { x: 44, y: 12.5 },
    { x: 48, y: 13.2 },
    { x: 52, y: 13.8 },
    { x: 56, y: 14.4 },
    { x: 60, y: 15.2 },
    { x: 64, y: 15.4 },
    { x: 68, y: 15.6 },
    { x: 72, y: 15.9 },
    { x: 76, y: 16.2 },
    { x: 80, y: 16.4 },
    { x: 84, y: 16.7 },
    { x: 88, y: 17.0 },
    { x: 92, y: 17.2 },
    { x: 96, y: 17.4 },
    { x: 100, y: 17.4 },
    { x: 104, y: 17.5 },
    { x: 108, y: 17.5 },
    { x: 112, y: 17.5 },
    { x: 116, y: 17.6 },
    { x: 120, y: 17.7 },
    { x: 124, y: 17.6 },
    { x: 128, y: 17.5 },
    { x: 132, y: 17.4 },
    { x: 136, y: 17.4 },
    { x: 140, y: 17.3 },
    { x: 144, y: 17.3 },
    { x: 148, y: 17.4 }
];



var week38PlusNoRisk = [
    { x: 0, y: 5 },
    { x: 4.1, y: 6 },
    { x: 8, y: 7.2 },
    { x: 11.7, y: 8.1 },
    { x: 16, y: 9.1 },
    { x: 19.6, y: 9.9 },
    { x: 23.6, y: 11 },
    { x: 29.2, y: 11.9 },
    { x: 36.1, y: 13 },
    { x: 41.1, y: 14 },
    { x: 47.1, y: 15 },
    { x: 52.8, y: 15.5 },
    { x: 59.4, y: 16 },
    { x: 64.9, y: 16.5 },
    { x: 71.3, y: 17 },
    { x: 78.4, y: 17.3 },
    { x: 86.4, y: 17.6 },
    { x: 94.9, y: 17.9 },
    { x: 102.2, y: 18.2 },
    { x: 111.6, y: 18.4 },
    { x: 119.3, y: 18.6 },
    { x: 128.9, y: 18.9 },
    { x: 137.8, y: 19 },
    { x: 143.3, y: 19 },
    { x: 152.5, y: 19 },
    { x: 159.3, y: 19 },
    { x: 167.4, y: 19 },
];

var week38PlusWithRisk = [
    { x: 0, y: 5 },
    { x: 4.1, y: 6 },
    { x: 9.8, y: 7.1 },
    { x: 13.9, y: 7.8 },
    { x: 17.2, y: 8.5 },
    { x: 21.9, y: 9.2 },
    { x: 26, y: 9.8 },
    { x: 30, y: 10.2 },
    { x: 36.6, y: 11.1 },
    { x: 42.1, y: 11.8 },
    { x: 47.5, y: 12.4 },
    { x: 54.4, y: 13 },
    { x: 61.5, y: 13.7 },
    { x: 66.3, y: 14 },
    { x: 71.3, y: 14.5 },
    { x: 83.7, y: 15 },
    { x: 90.8, y: 15.6 },
    { x: 95.8, y: 16 },
    { x: 109, y: 16.5 },
    { x: 119.1, y: 16.9 },
    { x: 127.1, y: 17.3 },
    { x: 130.8, y: 17.4 },
    { x: 138.8, y: 17.7 },
    { x: 144.2, y: 17.7 },
    { x: 154.8, y: 17.9 },
    { x: 159.6, y: 18 },
    { x: 162.8, y: 18 },
    { x: 167, y: 18 },
];

var week37NoRisk = [
    { x: 0, y: 5.1 },
    { x: 4.4, y: 6 },
    { x: 8.4, y: 6.8 },
    { x: 12.2, y: 7.6 },
    { x: 14.7, y: 8 },
    { x: 19.3, y: 8.8 },
    { x: 23.1, y: 9.4 },
    { x: 26.8, y: 9.9 },
    { x: 33.6, y: 10.8 },
    { x: 38.9, y: 11.4 },
    { x: 43.3, y: 11.9 },
    { x: 47.4, y: 12.4 },
    { x: 53.9, y: 13 },
    { x: 60.3, y: 13.5 },
    { x: 65.1, y: 13.9 },
    { x: 71.3, y: 14.4 },
    { x: 77.4, y: 14.9 },
    { x: 84.3, y: 15.4 },
    { x: 89.2, y: 15.8 },
    { x: 95, y: 15.9 },
    { x: 100.3, y: 16.1 },
    { x: 107.3, y: 16.5 },
    { x: 113.2, y: 16.7 },
    { x: 119.1, y: 16.9 },
    { x: 126.6, y: 17.2 },
    { x: 135.5, y: 17.5 },
    { x: 143.8, y: 17.7 },
    { x: 151.4, y: 17.9 },
    { x: 159.8, y: 18 },
    { x: 167.4, y: 18 },
];

var week37WithRisk = [
    { x: 0, y: 5.1 },
    { x: 3.5, y: 5.3 },
    { x: 6.6, y: 5.6 },
    { x: 11.7, y: 6 },
    { x: 18.7, y: 6.6 },
    { x: 23.4, y: 7 },
    { x: 27.1, y: 7.4 },
    { x: 30.1, y: 7.8 },
    { x: 34.9, y: 8.4 },
    { x: 39, y: 9 },
    { x: 42.5, y: 9.4 },
    { x: 45.4, y: 9.8 },
    { x: 49.3, y: 10.2 },
    { x: 52.2, y: 10.4 },
    { x: 55.5, y: 10.6 },
    { x: 60.3, y: 11.1 },
    { x: 63.1, y: 11.4 },
    { x: 66.5, y: 11.8 },
    { x: 71.7, y: 12.4 },
    { x: 75.4, y: 12.8 },
    { x: 79.7, y: 13 },
    { x: 84.7, y: 13.5 },
    { x: 88.6, y: 13.9 },
    { x: 94.3, y: 14.4 },
    { x: 98.3, y: 14.6 },
    { x: 102.9, y: 14.8 },
    { x: 109.3, y: 15 },
    { x: 112.1, y: 15 },
    { x: 115, y: 14.9 },
    { x: 119.5, y: 15 },
    { x: 123.9, y: 15 },
    { x: 127.5, y: 15 },
    { x: 133.1, y: 15 },
    { x: 139, y: 15 },
    { x: 144.9, y: 15 },
    { x: 151.1, y: 15 },
    { x: 157.4, y: 15 },
    { x: 163.1, y: 15 },
    { x: 167.5, y: 15 },
];    

function interpolate(x0, y0, x1, y1, x) {
    return y0 + ((y1 - y0) / (x1 - x0)) * (x - x0);
}

function getRiskZone(ageInHours, bilirubin, hasRisk, shouldUsePhototherapy){
    p40AtAge = getYOnCurveByX(percentile40DataPoints, ageInHours);
    p75AtAge = getYOnCurveByX(percentile75DataPoints, ageInHours);
    p95AtAge = getYOnCurveByX(percentile95DataPoints, ageInHours);
    var riskZone = -1;
    
    if (bilirubin >= p95AtAge){
        riskZone = 1;
        percentileString = 'מעל אחוזון 95';
    }
    if (bilirubin >= p75AtAge && bilirubin < p95AtAge){
        riskZone = 2;
        percentile = 75 + ((bilirubin - p75AtAge) / (p95AtAge - p75AtAge)) * 20;
        percentileString = 'באחוזון ' + percentile.toFixed(0);
    }
    if (bilirubin >= p40AtAge && bilirubin < p75AtAge){
        riskZone = 3;
        percentile = 40 + ((bilirubin - p40AtAge) / (p75AtAge - p40AtAge)) * 35;
        percentileString = 'באחוזון ' + percentile.toFixed(0);
    }
    if (bilirubin < p40AtAge){
        riskZone = 4;
        percentileString = 'מתחת לאחוזון 40';
    }
    var explanation = getTrackingStatusByRiskZone(riskZone, hasRisk, shouldUsePhototherapy);
    return { riskZone, percentileString, explanation };
}

function getTrackingStatusByRiskZone(riskZone, hasRisk, shouldUsePhototherapy){
    if ((riskZone === 1) || (riskZone === 2 && hasRisk)){
        if (shouldUsePhototherapy){
            return 'טיפול אור באשפוז';
        }
        else {
            return 'המשך אשפוז עם מעקב בילירובין בסרום כל 8 שעות';
        }
    }
    else if (riskZone === 2 && !hasRisk){
        return 'שחרור עם מעקב בילירובין חוזר תוך 24 שעות';
    }
    else if (riskZone === 4 || (!hasRisk && riskZone === 3)){
        return 'שחרור למעקב שגרתי בקהילה, רופא מטפל וטיפת חלב';
    }
    else if (hasRisk && riskZone === 3 ){
        return 'שחרור עם המלצה למעקב בילירובין חוזר, מלעורי או בסרום, תוך 48 שעות';
    }
}

function getDataPointsByCase(isWeek38Plus, hasRisk){
    if (isWeek38Plus){
        return hasRisk ? week38PlusWithRisk : week38PlusNoRisk; 
    }
    else{
        return hasRisk ? week37WithRisk : week37NoRisk; 
    }
}

function shouldUsePhototherapy(ageInHours, bilirubin, isWeek38Plus, hasRisk){
    var dataPoints = getDataPointsByCase(isWeek38Plus, hasRisk);
    var threshold = getYOnCurveByX(dataPoints, ageInHours);
    shouldUse = false;
    if (bilirubin >= threshold) {
        shouldUse = true;
    }
    return { shouldUse, delta: Math.abs(bilirubin - threshold).toFixed(1) }
}

function getYOnCurveByX(dataPoints, x) {
    // Avoid interpolate on X > defined range function.
    var maxDefinedX = dataPoints[dataPoints.length - 1].x;
    if (x > maxDefinedX){
        x = maxDefinedX;
    }
    // Find the two points between which the X coordinate lies
    var i = 0;
    while (i < dataPoints.length - 1 && dataPoints[i + 1].x < x) {
        i++;
    }

    // Interpolate Y value at X coordinate
    var interpolatedY = interpolate(
    dataPoints[i].x,
    dataPoints[i].y,
    dataPoints[i + 1].x,
    dataPoints[i + 1].y,
    x
    );

    return interpolatedY;
}