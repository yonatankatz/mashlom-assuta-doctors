  <!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>טריאז' ילדים</title>
<link rel="icon" href="https://www.assuta.co.il/images/favicon.svg">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-HVc1LYO1Gzlyr8h3itxj42/iDlGe2fvmU0nBUaqkYIrYz/yGxT2rRl1KByfETrhiRC3G8I3tDTUwpMkbKMBLIA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #f4f4f4;
    margin: 0;
    padding: 20px;
    padding-top: 0px;
  }
  thead, tbody tr {
  display: table;
  width: 100%;
  table-layout: fixed;
  }
  tbody {
  display: block;
  overflow-y: auto;
  table-layout: fixed;
  max-height: 500px;
  direction: rtl;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    border-spacing: 0;
    background-color: #fff;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
  }
  th, td {
    padding: 20px; /* Increased padding */
    text-align: center;
    width: 33%; /* Set a fixed width for each column (adjust as needed) */
    word-wrap: break-word; /* Wrap long content */
  }
  th {
    background-color: #007bff;
    color: #fff;
  }
  tr {
  cursor: pointer; /* Add pointer cursor to table rows */
  }
  tr:nth-child(even) {
    background-color: #f2f2f2;
  }
  .chip {
    display: inline-block;
    padding: 10px 15px;
    margin: 5px;
    border-radius: 20px;
    background-color: #007bff;
    color: #fff;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  .chip.selected {
    background-color: #0056b3;
  }
  .reset-search {
    background-color: #ff5722;
    color: #fff;
    margin: 10px;
  }
  /* Style for נקה בחירה chip */
  .reset-selection {
    background-color: #4caf50;
    color: #fff;
    margin: 10px;
  }
  .reset-all {
    color: #fff;
    margin: 3px;
  }
  .reset-buttons {
  display: inline-block;

  }
  .selected {
    background-color: #ffc107 !important;
  }
  .selected-row {
    background-color: #5980d6 !important;
  }
  .waiting-label {
    font-weight: bold;
    margin-bottom: 5px;
  }
  .search-container {
    text-align: center; /* Center-align the content */
    width: 20%; /* Set width to 50% of the screen */
    margin: 0 auto; /* Center horizontally */
    display: flex;
    align-items: center;
    margin-bottom: 10px;
  }
  .search-input {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 16px;
    background-color: #f8f8f8;
    background-image: url('https://www.w3schools.com/css/searchicon.png');
    background-position: 10px 10px;
    background-repeat: no-repeat;
    background-size: 15px;
    padding-left: 35px;
    box-sizing: border-box;
  }
  .selected-icon {
    color: green;
  }
  .waiting-time-group{
    padding: 15px;
    padding-top: 0px;
    text-align: center; /* Center-align the content */
  }
  .search-filter-group{
    padding-top: 15px;
    text-align: center; /* Center-align the content */
  }
  .filters-group{
    padding: 15px;
    text-align: center; /* Center-align the content */
    width: 60%; /* Set width to 60% of the screen */
    margin: 0 auto; /* Center horizontally */
  }
  .table-wrapper{
    padding: 15px;
    text-align: center; /* Center-align the content */
    width: 80%; /* Set width to 50% of the screen */
    margin: 0 auto; /* Center horizontally */
  }
    /* Fancy text area style */
  .fancy-textarea {
    font-weight: bold; 
    width: 80%;
    height: 50px;
    margin: 0 auto; /* Center horizontally */
    border: 1px solid #ccc;
    border-radius: 5px;
    background-color: #f8f8f8;
    padding: 10px;
    line-height: 1.5;
    overflow-y: auto;
    white-space: pre;
  }

</style>
</head>
<body>
<div class="">
  <div class="waiting-time-group">
    <div><div id="waitingTime" class="fancy-textarea">טרם נקבע</div></div>
  </div>
  <div class="search-filter-group">
    <div class="search-container">
      <input type="text" class="search-input" id="searchInput" onkeyup="searchTable()" placeholder="חיפוש לפי כל הערכים..">
      <div class="reset-buttons">
        <span class="reset-all" onclick="resetAll()"><img style="cursor:pointer; width: 20px; height: 20px;margin-right:10px; " src="assets/refresh.png"></span>
        <!-- <span class="chip reset-search" onclick="resetFilter(true)">נקה סינון</sp  an>
        <span class="chip reset-selection" onclick="resetSelected()">נקה בחירה</span> -->
      </div>  
    </div>
  </div>
  <div id="filters" class="filters-group">
    <span class="chip" onclick="toggleFilter(this, 'מצבים נשימתיים')">נשימתיים</span>
    <span class="chip" onclick="toggleFilter(this,'מצבים נוירולוגים לפי סקלת גלזגו')">נוירולוגיה</span>
    <span class="chip" onclick="toggleFilter(this,'מצבים קרדיווסקולרים')">לב</span>
    <span class="chip" onclick="toggleFilter(this,'טראומה')">טראומה</span>
    <span class="chip" onclick="toggleFilter(this,'מצבים גסטרואינטסטינלים + מערכת עיכול (אומדן דהידרציה)')">גסטרו</span>
    <span class="chip" onclick="toggleFilter(this,'המטולוגיה אימונולוגיה אלרגיה')">המטולוגיה אימונולוגיה אלרגיה</span>
    <span class="chip" onclick="toggleFilter(this,'מצבים אנדוקריניים')">אנדוקרינולוגיה</span>
    <span class="chip" onclick="toggleFilter(this,'עיניים')">עיניים</span>
    <span class="chip" onclick="toggleFilter(this,'גניקולוגיה')">גניקולוגיה</span>
    <span class="chip" onclick="toggleFilter(this,'דרכי מין ושתן')">דרכי מין ושתן</span>
    <span class="chip" onclick="toggleFilter(this,'אף אוזן גרון')">אף אוזן גרון</span>
    <span class="chip" onclick="toggleFilter(this,'מצבים זיהומיים')">זיהומים</span>
    <span class="chip" onclick="toggleFilter(this,'עור')">עור</span>
    <span class="chip" onclick="toggleFilter(this,'פסיכיאטריה')">פסיכיאטריה</span>
    <span class="chip" onclick="toggleFilter(this,'שינוי התנהגות')">שינוי התנהגות</span>
    <span class="chip" onclick="toggleFilter(this,'חשד להתעללות')">חשד להתעללות</span>
    <span class="chip" onclick="toggleFilter(this,'הרעלות והכשות')">הרעלות והכשות</span>
    <span class="chip" onclick="toggleFilter(this,'דרגת כאב')">כאב</span>

  </div>
</div>
<div id="tableContainer">
  <table id="dataTable" class="table-wrapper">
    <thead>
      <tr>
        <th>קטגוריה</th>
        <th>מקרה</th>
        <th>זמן המתנה לרופא</th>
      </tr>
    </thead>
    <tbody>
      <!-- Data will be populated here -->
    </tbody>
  </table>
</div>

<script>
  function convertToJson(inputJson) {
            let outputJson = [];

            inputJson.states.forEach(stateItem => {
                const state = stateItem.state;

                Object.keys(stateItem).forEach(key => {
                    if (key !== 'state') {
                        let level = key.split('-')[0];
                        level = level === "immediate" ? 0 : parseInt(level.substring(5));
                        const symptoms = stateItem[key].symptoms;

                        symptoms.forEach(symptom => {
                            outputJson.push({
                              category: state,
                              description: symptom,
                              value: level
                            });
                        });
                    }
                });
            });

            return outputJson;
        }

  function readJsonFromFile() { // TODO replace it with the real server path 
      fetch('canadian-pediatric-ed-triage.json')
          .then(response => response.json())
          .then(data => {
              const convertedData = convertToJson(data);
              console.log(convertedData);
              populateTable(convertedData)
          })
          .catch(error => console.error('Error reading JSON file:', error));
  }
  
  var selectedRows = [];
  var selectedCategories = [];
  readJsonFromFile();

  // Function to populate table with JSON data
  function populateTable(jsonData) {
    var tableBody = document.getElementById("dataTable").getElementsByTagName("tbody")[0];
    tableBody.innerHTML = ""; // Clear existing rows
    for (var i = 0; i < jsonData.length; i++) {
      var row = "<tr onclick='toggleRow(this, " + i + ")'>"; // Add onclick event to each row
      // var row = "<tr>";
      row += "<td>" + jsonData[i].category + "</td>";
      row += "<td>" + jsonData[i].description + "</td>";
      row += "<td>" + mapValue(jsonData[i].value) + "</td>";
      row += "</tr>";
      tableBody.innerHTML += row;
    }
  }
  function resetAll(){
    resetSelected();
    resetFilter(true);
    document.getElementById("waitingTime").style.backgroundColor = "";
  }

  function resetSelected() {
    var table = document.getElementById("dataTable");
    var rowsToDeselected = document.querySelectorAll(".selected-row");

    // Iterate through selected rows and remove "selected-row" class
    rowsToDeselected.forEach(function(row) {
        row.classList.remove("selected-row");
    });
    selectedRows = [];
    setWaitingTimeFiled();
  }

  function setWaitingTimeFiled(){
    const minTime = getMinWaitingTime(selectedRows);    
    document.getElementById("waitingTime").innerHTML = minTime + "<br>"; 
    if (minTime.indexOf("חדר הלם") > -1) {
      document.getElementById("waitingTime").style.backgroundColor = "#FE0000";
    }
    else if (minTime.indexOf("15 דקות") > -1) {
      document.getElementById("waitingTime").style.backgroundColor = "#ED4400";
    }
    else if (minTime.indexOf("30 דקות") > -1) {
      document.getElementById("waitingTime").style.backgroundColor = "#E7FF0D";
    }
    else if (minTime.indexOf("60 דקות") > -1) {
      document.getElementById("waitingTime").style.backgroundColor = "#44D113";
    }
    else if (minTime.indexOf("120 דקות") > -1) {
      document.getElementById("waitingTime").style.backgroundColor = "#3594E8";
    }
    else {
      document.getElementById("waitingTime").style.backgroundColor = "";
    }
    console.log(minTime);
  }

  function toggleRow(row, index) {
    if (row.classList.contains("selected-row")) {
      row.classList.remove("selected-row");
      var rowIndex = selectedRows.indexOf(index);
      if (rowIndex !== -1) {
        selectedRows.splice(rowIndex, 1); // Remove deselected row index from selectedRows
      }
    } else {
      row.classList.add("selected-row");
      selectedRows.push(index); // Add selected row index to selectedRows
    }
    console.log(selectedRows); // Print selected row indices (you can remove this)
    setWaitingTimeFiled();
  }

  function getMinWaitingTime(selectedRows) {
    var table = document.getElementById("dataTable");
    var waitingTimeColumnIndex = 2; // Index of the "זמן המתנה לרופא" column
    var caseColumnIndex = 1; // Index of the "מקרה" column
    var minWaitingTime = Infinity; // Initialize with a large value
    var reason;
    for (var i = 0; i < selectedRows.length; i++) {
        var rowIndex = selectedRows[i]+1;
        var cell = table.rows[rowIndex].cells[waitingTimeColumnIndex];
        
        var waitingTime = cell.textContent.trim();

        if (waitingTime === 'חדר הלם') {
            reason = table.rows[rowIndex].cells[caseColumnIndex].textContent.trim();
            return waitingTime + '<br>(' + reason + ') '; // Return 'חדר הלם' if found
        } else {
            var value = parseInt(waitingTime.split(' ')[0]);
            if (value < minWaitingTime){
              minWaitingTime = value;
              var reason = table.rows[rowIndex].cells[caseColumnIndex].textContent.trim();
            }
        }
    }
    const waitTimeString = minWaitingTime + ' דקות ';
    const waitTimeStringWithReason = waitTimeString + '<br>(' + reason + ')';
    return minWaitingTime === Infinity ? 'טרם נקבע' :  waitTimeStringWithReason;
}

  // Mapping function for values in the text box
  function mapValue(value) {
    switch (value) {
      case 0:
        return 'חדר הלם';
      case 2:
        return '15 דקות';
      case 3:
        return '30 דקות';
      case 4:
        return '60 דקות';
      case 5:
        return '120 דקות';
      default:
        return value;
    }
  }

  function toggleFilter(chipElement, category) {
  chipElement.classList.toggle('selected');
  if (chipElement.classList.contains('selected')) {
    selectedCategories.push(category); // Add category to the selected list
  } else {
    var index = selectedCategories.indexOf(category);
    if (index !== -1) {
      selectedCategories.splice(index, 1); // Remove category from the selected list
    }
  }
  filterTable();
  resetSearch();
}

function filterTable() {
  var table = document.getElementById("dataTable");
  var rows = table.getElementsByTagName("tr");
  for (var i = 0; i < rows.length; i++) {
    var categoryCell = rows[i].getElementsByTagName("td")[0];
    if (categoryCell) {
      var rowCategory = categoryCell.innerHTML;
      if (selectedCategories.length === 0 || selectedCategories.includes(rowCategory)) {
        rows[i].style.display = "";
      } else {
        rows[i].style.display = "none";
      }
    }
  }
}

  function resetSearch(){
    // Clear the search input field
    document.getElementById("searchInput").value = "";
  }
  function resetFilter(shouldResetSearch) {
    var chipElements = document.querySelectorAll('.chip');
    chipElements.forEach(function(chipElement) {
        chipElement.classList.remove('selected');
    });
    var table = document.getElementById("dataTable");
    var rows = table.getElementsByTagName("tr");
    for (var i = 0; i < rows.length; i++) {
      rows[i].style.display = "";
      rows[i].classList.remove("selected"); // Remove "selected" class
    }
    document.getElementById("waitingTime").value = "טרם נקבע"; // Reset waiting time
    selectedCategories = [];
    if (shouldResetSearch){
      resetSearch();
    }
  }

  function searchTable() {
    resetFilter(false);
    var input, filter, table, tr, td, i, txtValue;
    input = document.getElementById("searchInput");
    filter = input.value.toUpperCase();
    table = document.getElementById("dataTable");
    tr = table.getElementsByTagName("tr");
    for (i = 0; i < tr.length; i++) {
      td = tr[i].getElementsByTagName("td");
      for (var j = 0; j < td.length; j++) {
        if (td[j]) {
          txtValue = td[j].textContent || td[j].innerText;
          if (txtValue.toUpperCase().indexOf(filter) > -1) {
            tr[i].style.display = "";
            break; // If found in one cell, show the row
          } else {
            tr[i].style.display = "none";
          }
        }
      }
    }
  }

  document.addEventListener('keydown', function(event) {
    if (event.key.length === 1 || event.key === 'Backspace') {
      const waitingTimeElement = document.getElementById('searchInput');
      waitingTimeElement.focus();
    }
  });

</script>
</body>
</html>
